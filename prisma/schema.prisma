// Prisma schema for PM Tool - Project Management Application
// Database: PostgreSQL
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

/// Project member roles
enum ProjectRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

/// Task status in workflow
enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
}

/// Task priority level
enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ==================== MODELS ====================

/// User account and profile
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String?
  lastName  String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedProjects     Project[]       @relation("ProjectOwner")
  projectMemberships ProjectMember[]
  tasksAssigned     Task[]          @relation("TaskAssignee")
  tasksCreated      Task[]          @relation("TaskCreator")
  comments          Comment[]
  notifications     Notification[]
  activities        Activity[]

  @@index([email])
}

/// Project entity
model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String?  @default("#3b82f6")
  icon        String?  @default("folder")
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  owner   User            @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members ProjectMember[]
  tasks   Task[]
  activities Activity[]

  @@index([ownerId])
}

/// Project membership with roles
model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      ProjectRole @default(MEMBER)
  joinedAt  DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

/// Task within a project
model Task {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      TaskStatus @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  projectId   String
  assigneeId  String?
  creatorId   String
  dueDate     DateTime?
  position    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee  User?   @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  creator   User    @relation("TaskCreator", fields: [creatorId], references: [id], onDelete: Restrict)
  tags      TaskTag[]
  comments  Comment[]
  activities Activity[]

  @@index([projectId, status])
  @@index([assigneeId])
  @@index([dueDate])
  @@index([creatorId])
}

/// Tag for categorizing tasks
model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  color     String?  @default("#6366f1")
  createdAt DateTime @default(now())

  // Relations
  tasks TaskTag[]

  @@index([name])
}

/// Many-to-many relation between Task and Tag
model TaskTag {
  id        String   @id @default(cuid())
  taskId    String
  tagId     String
  createdAt DateTime @default(now())

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([taskId, tagId])
  @@index([taskId])
  @@index([tagId])
}

/// Comment on a task
model Comment {
  id        String   @id @default(cuid())
  content   String
  taskId    String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task      Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author    User   @relation(fields: [authorId], references: [id], onDelete: Restrict)

  @@index([taskId])
  @@index([authorId])
}

/// Notification for users
model Notification {
  id        String   @id @default(cuid())
  type      String   // e.g., TASK_ASSIGNED, TASK_MENTIONED, COMMENT_MENTIONED
  message   String
  userId    String
  isRead    Boolean  @default(false)
  metadata  Json?    // Additional data related to notification
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}

/// Activity log for auditing
model Activity {
  id        String   @id @default(cuid())
  type      String   // e.g., PROJECT_CREATED, TASK_CREATED, TASK_UPDATED
  action    String   // Description of the action
  projectId String?
  taskId    String?
  userId    String
  metadata  Json?    // Additional data about the activity
  createdAt DateTime @default(now())

  // Relations
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  task      Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)
  user      User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([projectId])
  @@index([taskId])
  @@index([userId])
  @@index([createdAt])
}
